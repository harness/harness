# Snapshot Tests for Registry Metadata Controllers

This directory contains snapshot files for testing the registry metadata API responses across all package types.

## What are Snapshot Tests?

Snapshot tests ensure that the generated API responses remain consistent across code changes. Each snapshot is a JSON file that captures the exact structure and content of the response for a specific package type and configuration.

## Directory Structure

```
testdata/
└── snapshots/
    ├── client_setup_details/    # Client setup instruction snapshots
    └── artifact_details/         # Artifact detail response snapshots
```

## Snapshot Files

### Client Setup Details (`snapshots/client_setup_details/`)

Contains 23 JSON files for:
- **All 10 package types**: Docker, Helm, Maven, Generic, Python, NPM, Nuget, Go, RPM, HuggingFace
- **Both authenticated and anonymous sessions**
- **Different registry types** (VIRTUAL, UPSTREAM)

Total: 23 snapshot files

### Artifact Details (`snapshots/artifact_details/`)

Contains 10 JSON files for:
- **All 10 package types**: Docker, Helm, Maven, Generic, Python, NPM, RPM, Nuget, Go, HuggingFace
- Captures complete artifact metadata structure including download counts and quarantine status

Total: 10 snapshot files

### Artifact Files (`snapshots/artifact_files/`) - Reference Snapshots

Contains 16 **reference snapshot files** for:
- **Maven, Generic, Python, NPM, RPM, Nuget, Go, HuggingFace** package types
- **Both authenticated and anonymous sessions**
- Documents the expected file listing response structure with download commands

**Note**: These are **reference snapshots** created manually, not generated by automated tests. The `GetArtifactFiles` endpoint requires FileManager with database access, making it unsuitable for unit testing. These snapshots serve as:
1. **API Documentation** - Shows the expected response format
2. **Integration Test Reference** - Template for integration tests
3. **Consumer Examples** - Examples for API users

**Key Differences**:
- **Authenticated**: Includes `--header 'Authorization: Bearer <API_KEY>'` in download commands
- **Anonymous**: No authentication headers in download commands

Total: 16 reference snapshot files (8 authenticated + 8 anonymous)

### Artifact Versions (`snapshots/artifact_versions/`)

Contains 8 JSON files for:
- **Maven, Generic, Python, NPM, RPM, Nuget, Go, HuggingFace** package types
- Lists all versions of an artifact with metadata

**Note**: Docker and Helm versions require TagRepository mocks and are not included in these snapshots.

Total: 8 snapshot files

### Artifacts List (`snapshots/artifacts/`)

Contains 3 JSON files for:
- **All artifacts** - Lists 10 artifacts covering all package types (tagged flow)
- **Artifacts with quarantine** - Shows quarantine information enrichment
- **All artifacts untagged images** - Lists 10 artifacts with untagged images flow for Docker/Helm

**Package Types Covered** (10 total):
- Docker, Helm, Maven, Generic, Python, NPM, RPM, Nuget, Go, HuggingFace

**Key Features**:
- All 10 package types with package-specific pull commands
- Quarantine status and reason
- Download counts
- Registry identifiers and paths
- Artifact type for HuggingFace (model)
- **Untagged images flow**: Docker and Helm use SHA256 digest format instead of version tags

**Untagged vs Tagged Images**:
- **Tagged** (default): 
  - Docker/Helm versions are tags like "v1.0.0"
  - No `metadata.tags` field
- **Untagged** (`UntaggedImagesEnabled=true`): 
  - Docker/Helm versions are digests like "sha256:0000...0001"
  - Includes `metadata.tags` array showing which tags point to this digest (e.g., `["v1.0.0", "latest"]`)

Total: 3 snapshot files

## Running Snapshot Tests

### Client Setup Details Snapshots

**Validation Mode:**
```bash
go test -v -run TestGenerateClientSetupDetailsSnapshot ./registry/app/api/controller/metadata/
```

**Update Mode:**
```bash
UPDATE_SNAPSHOTS=true go test -v -run TestGenerateClientSetupDetailsSnapshot ./registry/app/api/controller/metadata/
```

### Artifact Details Snapshots

**Validation Mode:**
```bash
go test -v -run TestGetArtifactDetailsSnapshot ./registry/app/api/controller/metadata/
```

**Update Mode:**
```bash
UPDATE_SNAPSHOTS=true go test -v -run TestGetArtifactDetailsSnapshot ./registry/app/api/controller/metadata/
```

### Artifact Versions Snapshots

**Validation Mode:**
```bash
go test -v -run TestGetAllArtifactVersionsSnapshot ./registry/app/api/controller/metadata/
```

**Update Mode:**
```bash
UPDATE_SNAPSHOTS=true go test -v -run TestGetAllArtifactVersionsSnapshot ./registry/app/api/controller/metadata/
```

### Artifacts List Snapshots

**Validation Mode:**
```bash
go test -v -run TestGetAllArtifactsSnapshot ./registry/app/api/controller/metadata/
```

**Update Mode:**
```bash
UPDATE_SNAPSHOTS=true go test -v -run TestGetAllArtifactsSnapshot ./registry/app/api/controller/metadata/
```

**⚠️ Important**: Only update snapshots when you've intentionally changed the response format. Review the diff carefully before committing updated snapshots.

## What Gets Tested

Each snapshot captures:
- Main header and secondary header text
- All setup sections (login, pull, push, etc.)
- Command templates with placeholders
- Step types (Static, GenerateToken, etc.)
- Section types (INLINE, TABS)
- Complete command structures with labels and values

## Benefits

1. **Prevents Regressions**: Catches unintended changes to client setup instructions
2. **Documentation**: Snapshots serve as documentation of the expected output
3. **Consistency**: Ensures all package types maintain consistent formatting
4. **Easy Review**: Changes to snapshots are visible in git diffs

## Example Snapshot Structure

```json
{
  "mainHeader": "Docker Client Setup",
  "secHeader": "Follow these instructions to install/use Docker artifacts or compatible packages.",
  "sections": [
    {
      "header": "Login to Docker",
      "steps": [
        {
          "commands": [
            {
              "label": "",
              "value": "docker login example.com"
            }
          ],
          "header": "Run this Docker command in your terminal to authenticate the client.",
          "type": "Static"
        }
      ],
      "type": "INLINE"
    }
  ]
}
```

## Troubleshooting

### Test Fails with "Snapshot mismatch"
1. Review the diff shown in the test output
2. If the change is intentional, update snapshots with `UPDATE_SNAPSHOTS=true`
3. If the change is unintentional, fix your code

### Snapshot File Missing
If you see "Snapshot file does not exist", run:
```bash
UPDATE_SNAPSHOTS=true go test -v -run TestGenerateClientSetupDetailsSnapshot ./registry/app/api/controller/metadata/
```

This will create the missing snapshot files.
